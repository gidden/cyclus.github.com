

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Testing Agents and Modules &mdash; Home</title>
    
    <link rel="stylesheet" href="../_static/cyclus.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Noticia+Text|Open+Sans|Droid+Sans+Mono" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '(1.3.0-rc5-32-g5ecfc06)',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/jquery.cookie.js"></script>
    <script type="text/javascript" src="../_static/cloud.js"></script>
    <link rel="shortcut icon" href="../_static/big_c.ico"/>
    <link rel="top" title="Home" href="../index.html" />
    <link rel="up" title="Cyclus Archetype Developer Guide" href="index.html" />
    <link rel="next" title="Time Step Execution" href="timestep.html" />
    <link rel="prev" title="Using the Cyclus Preprocessor" href="cycpp.html" /> 
        <meta name="viewport" content="width=device-width, initial-scale=1"><script type="text/javascript">
var ga_enabled = !$.cookie('disable-ga');
if(ga_enabled){
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-12222727-2']);
  _gaq.push(['_setCookiePath', '/']);
  _gaq.push(['_setDetectFlash', false]);
  _gaq.push(['_trackPageview']);
  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
}
</script>
  </head>
  <body>
    <div class="relbar-top">
        
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="timestep.html" title="Time Step Execution"
             accesskey="N">next</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="cycpp.html" title="Using the Cyclus Preprocessor"
             accesskey="P">previous</a> &nbsp; &nbsp;</li>
    <li><a href="../index.html">Home</a> &raquo;</li>

          <li><a href="index.html" accesskey="U"><span style="font-variant:small-caps;">Cyclus</span> Archetype Developer Guide</a> &raquo;</li> 
      </ul>
    </div>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="testing-agents-and-modules">
<span id="testing"></span><h1>Testing Agents and Modules<a class="headerlink" href="#testing-agents-and-modules" title="Permalink to this headline">¶</a></h1>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>Writing <a class="reference external" href="http://en.wikipedia.org/wiki/Unit_testing">unit tests</a> for your
module is a prerequisite for its addition to any <span style="font-variant:small-caps;">Cyclus</span> library, but it&#8217;s
really a <a class="reference external" href="http://software-carpentry.org/v4/test/unit.html">good idea anyway</a>.</p>
<p><span style="font-variant:small-caps;">Cyclus</span> makes use of the <a class="reference external" href="http://code.google.com/p/googletest/">Google Test</a> framework. The <a class="reference external" href="https://code.google.com/p/googletest/wiki/Primer">primer</a> is recommended as an
introduction to the fundamental concepts of unit testing with Google Test.
Seriously, if you&#8217;re unfamiliar with unit testing or Google Test, check out
the primer.</p>
</div>
<div class="section" id="unit-tests-out-of-the-box">
<h2>Unit Tests Out of the Box<a class="headerlink" href="#unit-tests-out-of-the-box" title="Permalink to this headline">¶</a></h2>
<p>The <span style="font-variant:small-caps;">Cyclus</span> dev team provides a number of unit tests for free (as in
beer). Really! You can unit test your <a class="reference internal" href="../basics/glossary.html#term-archetype"><em class="xref std std-term">archetype</em></a> immediately to confirm
some basic functionality with the <a class="reference internal" href="../basics/glossary.html#term-cyclus-kernel"><em class="xref std std-term">cyclus kernel</em></a>. We provide basic unit
tests for any class that inherits from one of:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">cyclus::Agent</span></tt></li>
<li><tt class="docutils literal"><span class="pre">cyclus::Facility</span></tt></li>
<li><tt class="docutils literal"><span class="pre">cyclus::Institution</span></tt></li>
<li><tt class="docutils literal"><span class="pre">cyclus::Region</span></tt></li>
</ul>
<p>Note that <tt class="docutils literal"><span class="pre">cyclus::Agent</span></tt> is the base class for any object that acts as an
<a class="reference internal" href="../basics/glossary.html#term-agent"><em class="xref std std-term">agent</em></a> in the simulation, so every archetype can invoke those unit tests.</p>
<p>In order to get the provided unit tests in your archetype&#8217;s tests, a few extra
lines must be added to your <tt class="docutils literal"><span class="pre">*_tests.cc</span></tt> file. For instance, the
<tt class="docutils literal"><span class="pre">TutorialFacility</span></tt> in the <a class="reference internal" href="hello_world.html#hello-world"><em>Hello, Cyclus!</em></a> example with the file structure
outline in <a class="reference internal" href="cmake.html#cmake-build"><em>Building Modules with CMake</em></a> adds the following lines to
<tt class="docutils literal"><span class="pre">tutorial_facility_tests.cc</span></tt> to get all of the free <tt class="docutils literal"><span class="pre">cyclus::Agent</span></tt> and
<tt class="docutils literal"><span class="pre">cyclus::Facility</span></tt> unit tests:</p>
<div class="highlight-python"><div class="highlight"><pre>#include &quot;tutorial_facility.h&quot;
#include &quot;facility_tests.h&quot;
#include &quot;agent_tests.h&quot;

#ifndef CYCLUS_AGENT_TESTS_CONNECTED
int ConnectAgentTests();
static int cyclus_agent_tests_connected = ConnectAgentTests();
#define CYCLUS_AGENT_TESTS_CONNECTED cyclus_agent_tests_connected
#endif // CYCLUS_AGENT_TESTS_CONNECTED

cyclus::Agent* TutorialFacilityConstructor(cyclus::Context* ctx) {
  return new TutorialFacility(ctx);
}

INSTANTIATE_TEST_CASE_P(TutorialFac, FacilityTests,
                        ::testing::Values(&amp;TutorialFacilityConstructor));

INSTANTIATE_TEST_CASE_P(TutorialFac, AgentTests,
                        ::testing::Values(&amp;TutorialFacilityConstructor));
</pre></div>
</div>
<p>The above lines can be specialized to your case by replacing <tt class="docutils literal"><span class="pre">TutorialFac</span></tt> with
an appropriate moniker (anything that uniquely identifies your unit test
name). Also, if you&#8217;re subclassing from <tt class="docutils literal"><span class="pre">cyclus::Institution</span></tt> or
<tt class="docutils literal"><span class="pre">cyclus::Region</span></tt>, replace all instances of facility in the above example with
the institution or region, respectively.</p>
</div>
<div class="section" id="unit-test-example">
<h2>Unit Test Example<a class="headerlink" href="#unit-test-example" title="Permalink to this headline">¶</a></h2>
<p>Now we will provide an example of a very simple <a class="reference internal" href="../basics/glossary.html#term-archetype"><em class="xref std std-term">archetype</em></a> that keeps
track of how many <a class="reference internal" href="../basics/glossary.html#term-tick"><em class="xref std std-term">ticks</em></a> it has experienced. We&#8217;ll call it
<tt class="docutils literal"><span class="pre">TickTracker</span></tt>.</p>
<p>This tutorial assumes that you have a directory setup like that described in
<a class="reference internal" href="hello_world.html#hello-world"><em>Hello, Cyclus!</em></a>, namely that there is a <cite>src</cite> directory in which
<a class="reference internal" href="../basics/glossary.html#term-archetype"><em class="xref std std-term">archetype</em></a> source files are housed and a <cite>install.py</cite> file that will
install them on your system.</p>
<p>Make a file called <tt class="docutils literal"><span class="pre">tick_tracker.h</span></tt> in the <tt class="docutils literal"><span class="pre">src</span></tt> directory that has the
following lines:</p>
<div class="highlight-cpp"><div class="highlight"><pre>#include &quot;cyclus.h&quot;

class TickTracker : public cyclus::Facility {
 public:
  TickTracker(cyclus::Context* ctx);

  #pragma cyclus

  /// increments n_ticks
  virtual void Tick();

  /// no-op
  virtual void Tock() {};

  /// query now many ticks the agent has experienced
  inline int n_ticks() const {return n_ticks_;}

 private:
  int n_ticks_;
};
</pre></div>
</div>
<p>Next, make a file called <tt class="docutils literal"><span class="pre">tick_tracker.cc</span></tt> in the <tt class="docutils literal"><span class="pre">src</span></tt> directory that has the
following lines:</p>
<div class="highlight-cpp"><div class="highlight"><pre><span class="cp">#include &quot;tick_tracker.h&quot;</span>

<span class="c1">// we have to call the base cyclus::Facility class&#39; constructor</span>
<span class="c1">// with a context argument</span>
<span class="n">TickTracker</span><span class="o">::</span><span class="n">TickTracker</span><span class="p">(</span><span class="n">cyclus</span><span class="o">::</span><span class="n">Context</span><span class="o">*</span> <span class="n">ctx</span><span class="p">)</span> <span class="o">:</span> <span class="n">n_ticks_</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">cyclus</span><span class="o">::</span><span class="n">Facility</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span> <span class="p">{};</span>

<span class="c1">// tick experienced!</span>
<span class="kt">void</span> <span class="n">TickTracker</span><span class="o">::</span><span class="n">Tick</span><span class="p">()</span> <span class="p">{</span><span class="n">n_ticks_</span><span class="o">++</span><span class="p">;}</span>
</pre></div>
</div>
<p>Now, make a file called <tt class="docutils literal"><span class="pre">tick_tracker_tests.cc</span></tt> in the <tt class="docutils literal"><span class="pre">src</span></tt> directory that
has the following lines:</p>
<div class="highlight-cpp"><div class="highlight"><pre><span class="c1">// gtest deps</span>
<span class="cp">#include &lt;gtest/gtest.h&gt;</span>

<span class="c1">// cyclus deps</span>
<span class="cp">#include &quot;facility_tests.h&quot;</span>
<span class="cp">#include &quot;agent_tests.h&quot;</span>
<span class="cp">#include &quot;test_context.h&quot;</span>

<span class="c1">// our deps</span>
<span class="cp">#include &quot;tick_tracker.h&quot;</span>

<span class="c1">// write a unit test of our own</span>
<span class="n">TEST</span><span class="p">(</span><span class="n">TickTracker</span><span class="p">,</span> <span class="n">track_ticks</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">cyclus</span><span class="o">::</span><span class="n">TestContext</span> <span class="n">ctx</span><span class="p">;</span>
  <span class="n">TickTracker</span> <span class="nf">fac</span><span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="n">get</span><span class="p">());</span>
  <span class="n">EXPECT_EQ</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">fac</span><span class="p">.</span><span class="n">n_ticks</span><span class="p">());</span>
  <span class="n">fac</span><span class="p">.</span><span class="n">Tick</span><span class="p">();</span>
  <span class="n">EXPECT_EQ</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">fac</span><span class="p">.</span><span class="n">n_ticks</span><span class="p">());</span>
  <span class="n">fac</span><span class="p">.</span><span class="n">Tick</span><span class="p">();</span>
  <span class="n">EXPECT_EQ</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">fac</span><span class="p">.</span><span class="n">n_ticks</span><span class="p">());</span>
<span class="p">}</span>

<span class="c1">// get all the basic unit tests</span>
<span class="cp">#ifndef CYCLUS_AGENT_TESTS_CONNECTED</span>
<span class="kt">int</span> <span class="n">ConnectAgentTests</span><span class="p">();</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">cyclus_agent_tests_connected</span> <span class="o">=</span> <span class="n">ConnectAgentTests</span><span class="p">();</span>
<span class="cp">#define CYCLUS_AGENT_TESTS_CONNECTED cyclus_agent_tests_connected</span>
<span class="cp">#endif </span><span class="c1">// CYCLUS_AGENT_TESTS_CONNECTED</span>

<span class="n">cyclus</span><span class="o">::</span><span class="n">Agent</span><span class="o">*</span> <span class="n">TickTrackerConstructor</span><span class="p">(</span><span class="n">cyclus</span><span class="o">::</span><span class="n">Context</span><span class="o">*</span> <span class="n">ctx</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="n">TickTracker</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">INSTANTIATE_TEST_CASE_P</span><span class="p">(</span><span class="n">TicTrac</span><span class="p">,</span> <span class="n">FacilityTests</span><span class="p">,</span>
                        <span class="o">::</span><span class="n">testing</span><span class="o">::</span><span class="n">Values</span><span class="p">(</span><span class="o">&amp;</span><span class="n">TickTrackerConstructor</span><span class="p">));</span>

<span class="n">INSTANTIATE_TEST_CASE_P</span><span class="p">(</span><span class="n">TicTrac</span><span class="p">,</span> <span class="n">AgentTests</span><span class="p">,</span>
                        <span class="o">::</span><span class="n">testing</span><span class="o">::</span><span class="n">Values</span><span class="p">(</span><span class="o">&amp;</span><span class="n">TickTrackerConstructor</span><span class="p">));</span>
</pre></div>
</div>
<p>Add the following lines to the <tt class="docutils literal"><span class="pre">src/CMakeLists.txt</span></tt> file:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">INSTALL_CYCLUS_STANDALONE</span><span class="p">(</span><span class="s">&quot;TickTracker&quot;</span> <span class="s">&quot;tick_tracker&quot;</span> <span class="s">&quot;tutorial&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Now we&#8217;re ready to install the <tt class="docutils literal"><span class="pre">TickTracker</span></tt> module and run its tests. If you
haven&#8217;t already, now is a good time to add the <tt class="docutils literal"><span class="pre">$CYCLUS_INSTALL_PATH</span></tt> to your
<tt class="docutils literal"><span class="pre">PATH</span></tt> environment variable (<span style="font-variant:small-caps;">Cyclus</span>&#8216; <tt class="docutils literal"><span class="pre">install.py</span></tt> defaults to
<tt class="docutils literal"><span class="pre">~/.local</span></tt>). Next, from your top level directory (where your <tt class="docutils literal"><span class="pre">install.py</span></tt>
file is), run:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>./install.py
<span class="nv">$ </span>TickTracker_unit_tests
</pre></div>
</div>
<p>Which results in:</p>
<div class="highlight-python"><div class="highlight"><pre>[==========] Running 8 tests from 3 test cases.
[----------] Global test environment set-up.
[----------] 1 test from TickTracker
[ RUN      ] TickTracker.track_ticks
[       OK ] TickTracker.track_ticks (19 ms)
[----------] 1 test from TickTracker (20 ms total)

[----------] 5 tests from TicTrac/AgentTests
[ RUN      ] TicTrac/AgentTests.Clone/0
[       OK ] TicTrac/AgentTests.Clone/0 (8 ms)
[ RUN      ] TicTrac/AgentTests.Print/0
[       OK ] TicTrac/AgentTests.Print/0 (9 ms)
[ RUN      ] TicTrac/AgentTests.Schema/0
[       OK ] TicTrac/AgentTests.Schema/0 (9 ms)
[ RUN      ] TicTrac/AgentTests.Annotations/0
[       OK ] TicTrac/AgentTests.Annotations/0 (15 ms)
[ RUN      ] TicTrac/AgentTests.GetAgentType/0
[       OK ] TicTrac/AgentTests.GetAgentType/0 (8 ms)
[----------] 5 tests from TicTrac/AgentTests (49 ms total)

[----------] 2 tests from TicTrac/FacilityTests
[ RUN      ] TicTrac/FacilityTests.Tick/0
[       OK ] TicTrac/FacilityTests.Tick/0 (9 ms)
[ RUN      ] TicTrac/FacilityTests.Tock/0
[       OK ] TicTrac/FacilityTests.Tock/0 (8 ms)
[----------] 2 tests from TicTrac/FacilityTests (17 ms total)

[----------] Global test environment tear-down
[==========] 8 tests from 3 test cases ran. (86 ms total)
[  PASSED  ] 8 tests.
</pre></div>
</div>
</div>
<div class="section" id="testing-resource-exchange">
<h2>Testing Resource Exchange<a class="headerlink" href="#testing-resource-exchange" title="Permalink to this headline">¶</a></h2>
<p>One of the most important things to test is your archetype&#8217;s resource exchange
behavior.  Does it request/receive the right kinds of material?  Does it offer/sell
resources at the right time?  One of the best ways to test this is to actually
run a simulation with your archetype.  Cyclus comes with a mock simulation
environment that makes it easy to write these kinds of tests in a way that
works well with gtest.</p>
<p><tt class="docutils literal"><span class="pre">MockSim</span></tt> is a helper for running full simulations entirely in-code without
having to deal with input files, output database files, and other pieces of
the full Cyclus stack.  All you have to do is initialize a MockSim indicating
the archetype you want to test and the simulation duration.  Then add any
number of sources and/or sinks to transact with your agent.  They can have
specific recipes (or not) and their deployment and lifetime (before
decommissioning) can be specified too.  Here is an example using the
agents:Source archetype in Cyclus as the tested agent:</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">// Define a composition to use as a simulation recipe.</span>
<span class="n">cyclus</span><span class="o">::</span><span class="n">CompMap</span> <span class="n">m</span><span class="p">;</span>
<span class="n">m</span><span class="p">[</span><span class="mi">922350000</span><span class="p">]</span> <span class="o">=</span> <span class="mf">.05</span><span class="p">;</span>
<span class="n">m</span><span class="p">[</span><span class="mi">922380000</span><span class="p">]</span> <span class="o">=</span> <span class="mf">.95</span><span class="p">;</span>
<span class="n">cyclus</span><span class="o">::</span><span class="n">Composition</span><span class="o">::</span><span class="n">Ptr</span> <span class="n">fresh</span> <span class="o">=</span> <span class="n">cyclus</span><span class="o">::</span><span class="n">Composition</span><span class="o">::</span><span class="n">CreateFromMass</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>

<span class="c1">// Define our archetype xml configuration.</span>
<span class="c1">// This is the info that goes</span>
<span class="c1">// &quot;&lt;config&gt;&lt;[archetype-name]&gt;here&lt;/[archetype-name]&gt;&lt;/config&gt;&quot;</span>
<span class="c1">// in the input file.</span>
<span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">config</span> <span class="o">=</span>
    <span class="s">&quot;&lt;commod&gt;enriched_u&lt;/commod&gt;&quot;</span>
    <span class="s">&quot;&lt;recipe_name&gt;fresh_fuel&lt;/recipe_name&gt;&quot;</span>
    <span class="s">&quot;&lt;capacity&gt;10&lt;/capacity&gt;&quot;</span><span class="p">;</span>

<span class="c1">// Create and run a 10 time step mock simulation</span>
<span class="kt">int</span> <span class="n">dur</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
<span class="n">cyclus</span><span class="o">::</span><span class="n">MockSim</span> <span class="n">sim</span><span class="p">(</span><span class="n">cyclus</span><span class="o">::</span><span class="n">AgentSpec</span><span class="p">(</span><span class="s">&quot;:agents:Source&quot;</span><span class="p">),</span> <span class="n">config</span><span class="p">,</span> <span class="n">dur</span><span class="p">);</span>
<span class="n">sim</span><span class="p">.</span><span class="n">AddRecipe</span><span class="p">(</span><span class="s">&quot;fresh_fuel&quot;</span><span class="p">,</span> <span class="n">fresh</span><span class="p">);</span> <span class="c1">// with one composition recipe</span>
<span class="n">sim</span><span class="p">.</span><span class="n">AddSink</span><span class="p">(</span><span class="s">&quot;enriched_u&quot;</span><span class="p">)</span> <span class="c1">// and one sink facility</span>
    <span class="p">.</span><span class="n">recipe</span><span class="p">(</span><span class="s">&quot;fresh_fuel&quot;</span><span class="p">)</span> <span class="c1">// requesting a particular recipe</span>
    <span class="p">.</span><span class="n">capacity</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="c1">// with a 5 kg per time step receiving limit</span>
    <span class="p">.</span><span class="n">Finalize</span><span class="p">();</span> <span class="c1">// (don&#39;t forget to call this for each source/sink you add)</span>

<span class="n">sim</span><span class="p">.</span><span class="n">AddSink</span><span class="p">(</span><span class="s">&quot;enriched_u&quot;</span><span class="p">)</span> <span class="c1">// And another sink facility</span>
        <span class="c1">// requesting no particular recipe</span>
        <span class="c1">// and with infinite capacity</span>
    <span class="p">.</span><span class="n">start</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="c1">// that isn&#39;t built until the 3rd timestep.</span>
    <span class="p">.</span><span class="n">Finalize</span><span class="p">();</span>
<span class="kt">int</span> <span class="n">agent_id</span> <span class="o">=</span> <span class="n">sim</span><span class="p">.</span><span class="n">Run</span><span class="p">();</span> <span class="c1">// capture the ID of the agent being tested</span>
</pre></div>
</div>
<p>The parameters that can be set (or not) for each source/sink are:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">recipe(std::string</span> <span class="pre">r)</span></tt>: The recipe to request/provide. Default is none -
sources provide requested material, sinks take anything.</li>
<li><tt class="docutils literal"><span class="pre">capacity(double</span> <span class="pre">cap)</span></tt>: The per time step throughput/capacity limit for
the source/sink. Default is infinite.</li>
<li><tt class="docutils literal"><span class="pre">start(int</span> <span class="pre">t)</span></tt>: Time the source/sink is initially built. Default is time
step zero.</li>
<li><tt class="docutils literal"><span class="pre">lifetime(int)</span></tt>: The number of time steps the source/sink is deployed
until automatic decommissioning. Default is infinite (never decommissioned).</li>
</ul>
<p>For more details, you can read the <a class="reference external" href="http://fuelcycle.org/cyclus/api/classcyclus_1_1MockSim.html">MockSim API docs</a>.
Querying simulation results can be accomplished by getting a reference to the
in-memory database generated.  Not all data that is present in normal
full-stack simulations is available.  However, most of the key core tables are
fully available.  Namely the Transactions, Composition, Resources,
ResCreators, AgentEntry, and AgentExit tables are available.  Any
custom-tables created by the tested archetype will also be available.  Here is
a sample query and test you might write using the gtest framework:</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">// return all transactions where our source facility is the sender</span>
<span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">cyclus</span><span class="o">::</span><span class="n">Cond</span><span class="o">&gt;</span> <span class="n">conds</span><span class="p">;</span>
<span class="n">conds</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="s">&quot;SenderId&quot;</span><span class="p">,</span> <span class="s">&quot;==&quot;</span><span class="p">,</span> <span class="n">agent_id</span><span class="p">);</span>
<span class="n">cyclus</span><span class="o">::</span><span class="n">QueryResult</span> <span class="n">qr</span> <span class="o">=</span> <span class="n">sim</span><span class="p">.</span><span class="n">db</span><span class="p">().</span><span class="n">Query</span><span class="p">(</span><span class="s">&quot;Transactions&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conds</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">n_trans</span> <span class="o">=</span> <span class="n">qr</span><span class="p">.</span><span class="n">rows</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
<span class="n">EXPECT_EQ</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">n_trans</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;expected 10 transactions, got &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">n_trans</span><span class="p">;</span>

<span class="c1">// reconstruct the material object for the first transaction</span>
<span class="kt">int</span> <span class="n">res_id</span> <span class="o">=</span> <span class="n">qr</span><span class="p">.</span><span class="n">GetVal</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;ResourceId&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">cyclus</span><span class="o">::</span><span class="n">Material</span><span class="o">::</span><span class="n">Ptr</span> <span class="n">m</span> <span class="o">=</span> <span class="n">sim</span><span class="p">.</span><span class="n">GetMaterial</span><span class="p">(</span><span class="n">res_id</span><span class="p">);</span>
<span class="n">EXPECT_DOUBLE_EQ</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">quantity</span><span class="p">());</span>

<span class="c1">// confirm composition is as expected</span>
<span class="n">cyclus</span><span class="o">::</span><span class="n">toolkit</span><span class="o">::</span><span class="n">MatQuery</span> <span class="n">mq</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
<span class="n">EXPECT_DOUBLE_EQ</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">mq</span><span class="p">.</span><span class="n">mass</span><span class="p">(</span><span class="mi">922350000</span><span class="p">));</span>
<span class="n">EXPECT_DOUBLE_EQ</span><span class="p">(</span><span class="mf">9.5</span><span class="p">,</span> <span class="n">mq</span><span class="p">.</span><span class="n">mass</span><span class="p">(</span><span class="mi">922380000</span><span class="p">));</span>
</pre></div>
</div>
<p>You can read API documentation for the <a class="reference external" href="http://fuelcycle.org/cyclus/api/classcyclus_1_1QueryableBackend.html">queryable database</a> and
<a class="reference external" href="http://fuelcycle.org/cyclus/api/classcyclus_1_1QueryResult.html">query results</a> for more
details.</p>
</div>
<div class="section" id="debugging">
<h2>Debugging<a class="headerlink" href="#debugging" title="Permalink to this headline">¶</a></h2>
<p>Cyclus has the ability to dump extra information about a simulation run&#8217;s
resource exchange into the database.  This information can be
particularly helpful for debugging and verifying your archetype&#8217;s behavior
with respect to resource exchange.  To turn on this debugging, simply run
cyclus with the environment variable <tt class="docutils literal"><span class="pre">CYCLUS_DEBUG_DRE</span></tt> set to any non-empty
value:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ CYCLUS_DEBUG_DRE</span><span class="o">=</span>1 cyclus my-sim.xml
</pre></div>
</div>
<p>The database will then contain two extra tables with several columns each:</p>
<ul class="simple">
<li><strong>DebugRequests</strong>: record of every resource request made in the simulation.<ul>
<li><tt class="docutils literal"><span class="pre">SimId</span></tt>:  simulation UUID</li>
<li><tt class="docutils literal"><span class="pre">Time</span></tt>:  time step of the request</li>
<li><tt class="docutils literal"><span class="pre">ReqId</span></tt>, simulation-unique identifier for this request</li>
<li><tt class="docutils literal"><span class="pre">RequesterID</span></tt>: ID of the requesting agent</li>
<li><tt class="docutils literal"><span class="pre">Commodity</span></tt>: the commodity of the request</li>
<li><tt class="docutils literal"><span class="pre">Preference</span></tt>: agent&#8217;s preference for this particular request</li>
<li><tt class="docutils literal"><span class="pre">Exclusive</span></tt>: true (non-zero) if this request is all-or-nothing (integral)</li>
<li><tt class="docutils literal"><span class="pre">ResType</span></tt>: resource type (e.g. &#8220;Material&#8221;, &#8220;Product&#8221;)</li>
<li><tt class="docutils literal"><span class="pre">Quantity</span></tt>: amount of the request</li>
<li><tt class="docutils literal"><span class="pre">ResUnits</span></tt>: units of the request (e.g. kg)</li>
</ul>
</li>
<li><strong>DebugBids</strong>: record of every resource bid made in the simulation.<ul>
<li><tt class="docutils literal"><span class="pre">SimId</span></tt>: simulation UUID</li>
<li><tt class="docutils literal"><span class="pre">ReqId</span></tt>: simulation-unique identifier for the bid&#8217;s request</li>
<li><tt class="docutils literal"><span class="pre">BidderId</span></tt>: ID of the the bidding agent</li>
<li><tt class="docutils literal"><span class="pre">BidQuantity</span></tt>: amount of thd bid</li>
<li><tt class="docutils literal"><span class="pre">Exclusive</span></tt>: true(non-zero) if this request is all-or-nothing (integral)</li>
</ul>
</li>
</ul>
<p>Note that some information about bids can be inferred from corresponding
requests.  A bid&#8217;s time, commodity, resource type, and units are all identical
to those of the corresponding request.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
        <p class="logo"><a href="../index.html" title="index">
          <img class="logo" src="../_static/big_c.png" alt="Logo"/>
        </a></p><div class="sphinxlocaltoc">
    <h3><a href="../index.html">Page contents</a></h3>
    <ul>
<li><a class="reference internal" href="#">Testing Agents and Modules</a><ul>
<li><a class="reference internal" href="#overview">Overview</a></li>
<li><a class="reference internal" href="#unit-tests-out-of-the-box">Unit Tests Out of the Box</a></li>
<li><a class="reference internal" href="#unit-test-example">Unit Test Example</a></li>
<li><a class="reference internal" href="#testing-resource-exchange">Testing Resource Exchange</a></li>
<li><a class="reference internal" href="#debugging">Debugging</a></li>
</ul>
</li>
</ul>

  </div>
  <div class="sphinxprev">
    <h4>Previous page</h4>
    <p class="topless"><a href="cycpp.html"
                          title="Previous page">&larr; Using the Cyclus Preprocessor</a></p>
  </div>
  <div class="sphinxnext">
    <h4>Next page</h4>
    <p class="topless"><a href="timestep.html"
                          title="Next page">&rarr; Time Step Execution</a></p>
  </div>
  <div class="sphinxlocaltoc">
  <h3>Useful Pages</h3>
    <ul><li><ul>
    <li><a href="/user/index.html">User Guide</a></li>
    <li><a href="/arche/index.html">Archetype Developer Guide</a></li>
    <li><a href="http://fuelcycle.org/cyclus/api/">Cyclus API Documentation</a></li>
    <li><a href="http://fuelcycle.org/cycamore/api/">Cycamore API Documentation</a></li>
    <li><a href="/basics/glossary.html">Glossary</a></li>
    <li><a href="mailto:cyclus-users+subscribe@googlegroups.com?subject=Subscribe&body=Send this message to subscribe to the list">Join</a> the 
      <a href="https://groups.google.com/forum/#!forum/cyclus-users" target="_blank"><span style="font-variant:small-caps">Cyclus</span> Users</a> mailing list.
    <li><a href="mailto:cyclus-dev+subscribe@googlegroups.com?subject=Subscribe&body=Send this message to subscribe to the list">Join</a> the 
      <a href="https://groups.google.com/forum/#!forum/cyclus-users" target="_blank"><span style="font-variant:small-caps">Cyclus</span> Developers</a> mailing list.
    </ul></li></ul>
  </div>
    
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
    <h3>Get Cyclus</h3>
    <br>
    Current version: <b>1.2.0</b>
    <br><br>
    Install:
    <div class="highlight-bash" style="width:97.5%"><div class="highlight"><pre><span class="nv">$ </span>conda install cyclus cycamore</pre></div></div>
    Get the Source:
    <ul><li><ul>
          <li><a href="https://github.com/cyclus/cyclus">Cyclus</a></li>
          <li><a href="https://github.com/cyclus/cycamore">Cycamore</a></li>
    </ul></li></ul>
    <h3>Acknowledgements</h3>
    The Cyclus project has received support from:
    <br />
    <a href="http://www.neup.gov" target="_blank"><img src="../_static/neup_logo_large.png" width=170px></a>
    <br />
    <br />

    In addition, some of the students working on Cyclus have received support from:
    <br />
    <a href="http://www.anl.gov" target="_blank"><img src="../_static/AnlLogo.png" height=100px></a>
    <a href="http://www.nrc.gov" target="_blank"><img src="../_static/USNRC.png" height=100px></a>
    <br />
    <a href="http://www.neup.gov" target="_blank"><img src="../_static/neup_logo_large.png" width=170px></a>
    <br />
    <a href="http://www.nsf.gov" target="_blank"><img src="../_static/nsf_logo.png" height=100px></a>
    <a href="http://www.wisc.edu" target="_blank"><img src="../_static/crest.png" height=100px></a>

    

        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="relbar-bottom">
        
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="timestep.html" title="Time Step Execution"
             >next</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="cycpp.html" title="Using the Cyclus Preprocessor"
             >previous</a> &nbsp; &nbsp;</li>
    <li><a href="../index.html">Home</a> &raquo;</li>

          <li><a href="index.html" ><span style="font-variant:small-caps;">Cyclus</span> Archetype Developer Guide</a> &raquo;</li> 
      </ul>
    </div>
    </div>

    <div class="footer">
        &copy; Copyright 2012-2014, University of Wisconsin Computational Nuclear Engineering Research Group.
      Last updated on May 20, 2015.
    </div><script type="text/javascript">
    if(ga_enabled){
        document.write("<div class=\"footer\">This page uses <a href=\"http://analytics.google.com\">Google Analytics</a> to collect statistics. ");
        document.write("Click <button title=\"set cookie to disable analytics for this site\" class=\"link\" onclick=\"$.cookie('disable-ga', 'true', {expires: 3650, path: '/'}); window.location.reload(); return false; \">here</button> to disable analytics for this site.");
        document.write("</div>");
    }else{
        document.write("<div class=\"footer\">Google Analytics has been disabled. ");
        document.write("Click <button title=\"set cookie to re-enable analytics for this site\" class=\"link\" onclick=\"$.cookie('disable-ga', null, {path: '/'}); window.location.reload(); return false; \">here</button> to re-enable analytics for this site.");
    };
</script>
    <!-- cloud_sptheme 1.4 -->
  </body>
</html>